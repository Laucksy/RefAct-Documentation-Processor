<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/css/bootstrap-select.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>
</head>

<body>
  <div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 bg-dark">
    <h5 class="my-0 mr-md-auto font-weight-normal text-light">Lafayette College Refugee Action</h5>
    <a class="btn btn-light" href="http://www.lafrefact.com">Visit our site</a>
  </div>

  <section class="jumbotron text-center">
    <div class="container">
      <h1 class="jumbotron-heading">Welcome to the RefAct Documentation Processor!</h1>
      <p class="lead text-muted">This is a tool for automatically generating reports about the resettlement process based upon a database of information. This tool also allows for easy editing of that database to make editing the reports easy.</p>
      <p>
      <a href="#" class="btn btn-primary my-2" onclick="loadDoc()">Click here to generate the report.</a>
      </p>
    </div>
  </section>

  <div class="text-center">
    <div class="btn-group">
      <a href="#" id="btnCat" class="btn btn-secondary" onclick="handleClick('categories')">Categories</a>
      <a href="#" id="btnTas" class="btn btn-light" onclick="handleClick('tasks')">Tasks</a>
      <a href="#" id="btnPap" class="btn btn-light" onclick="handleClick('paperwork')">Paperwork</a>
    </div>
  </div>
  <br/>
  <br/>
  <div id="content-table" class="container"></div>

  <script type="text/javascript">
    const state = {
      categories: [],
      tasks: [],
      paperwork: [],
      active: 'categories',
      TIME_PERIODS: []
    }

    window.onload = function () {
      makeRequest("GET", "http://54.183.93.210:3001/data", null, function (res) {
        let data = JSON.parse(res.responseText);
        updateState(data);
      }, function(err) {
        let data = {
          categories: [{
            "number": 1,
            "title": "The Resettlement Agency",
            "intro": "\t There are 9 major resettlement agencies in the US, with each one having smaller, affiliate organizations that somewhat-independently conduct their own resettlement operations. The agency for the Lehigh Valley is Bethany Christian Services (BCS, which will refer directly to the Lehigh Valley office), which is an affiliate of Lutheran Immigration and Refugee Services (LIRS). Though BCS used to be rather sizable, budget cuts in recent years have reduced the organization to three paid staff, along with a network of volunteers. The three staff members are Marla Sell, the director, Mohammed Obaid, the general case worker, and Mu Kpaw, the employment case worker. The general case worker will be referenced as just the case worker, since they handle everything except for employment. The BCS office is located at the corner of 5th Street and Linden Street in Allentown, in the second floor offices of the Grace Episcopal Church. \n\t Once BCS has notified you (the sponsoring organization) of an arrival, it is up to you to determine if you should decide to spoonsor them. There may be a variety of factors involved, such as the number of people, their ages, the availability of housing, etc. BCS will provide a biodata form that gives basic information about each person in the case, including their name, date of birth, country of nationality, country of origin (which necessarily must be different than country of nationality to be considered a refugee by the UNHCR), notable medical concerns, languages spoken/literate in, education experience, and employment experience. This information is all that you get prior to their arrival, so you must do your best to prepare with it. A lot of things can be acted upon with just this, such as gathering beds/furniture, identifying a culturally appropriate meal for the night of their arrival, and searching (in-group and out) for translators, but other things, such as school enrollment and necessary medical appointments, must wait until their arrival. \n",
            "sections": [
              {
                "title": "Cultural Orientation",
                "description": "\t After the family has arrived and settled in, they will begin Cultural Orientation through BCS. This is run in the home by two BCS volunteers, a facilitator and a translator, and covers a range of topics, listed below (a more descriptive version can be found in the Appendix): \n LIST[[Role of the Local Resettlement Agency],[Refugee Status], [English], [Public Assistance], [U.S. Laws], [Your New Community], [Employment], [Health], [Budgeting and Personal Finance], [Housing], [Hygiene], [Safety], [Cultural Adjustment], [Education], [Transportation]] \t This Cultural Orientation will talk place over approximately four two hour sessions and concludes with a written exam (in English) aimed at assessing a general understanding of all of the topics. This exam is assisted by the translator and can be taken multiple times until satisfactorily completed, at the discretion of BCS. \n",
                "subsections": []
              },
              {
                "title": "The Case Worker",
                "description": "\t The case worker plays a critical role in the resettlement process and should serve as the main point of contact with the resettlement agency, although the director is more than willing and to help and answer questions as needed. The case worker will does the intake paperwork with BCS and facilitate much of the governmental interactions for the family, such as getting the first month of SNAP benefits expedited. The case worker is actively involved until the three month mark, at which they complete a summarizing report and significantly decrease involvement and contact with the family. This can change, however, due to extenuating circumstances and they will continue to answer questions and such after the three month mark. \n",
                "subsections": []
              },
              {
                "title": "Refugee Social Services",
                "description": "\t After the case worker is no longer actively associated with the family, they will enter into the resettlement agency's Refugee Social Services program. This program provides them with more infrequent, somewhat-on-demand assistance. Much of this is done through the Episcopal Church of the Mediator in Allentown, which runs the Refugee Center, at which the director of BCS holds \"office hours\" and through which the family can get school uniforms for the kids. \n",
                "subsections": []
              }
            ]
          }]
        };
        updateState(data);
      });
    }

    function handleClick(tab) {
      state.active = tab;
      document.getElementById("btnCat").className = "btn" + (tab === "categories" ? " btn-secondary" : " btn-light");
      document.getElementById("btnTas").className = "btn" + (tab === "tasks" ? " btn-secondary" : " btn-light");
      document.getElementById("btnPap").className = "btn" + (tab === "paperwork" ? " btn-secondary" : " btn-light");
      render();
    }

    function updateState(data) {
      if (data.categories) state.categories = data.categories.sort(function (a, b) { return a.number - b.number });
      if (data.tasks) state.tasks = data.tasks;
      if (data.paperwork) state.paperwork = data.paperwork;
      if (data.TIME_PERIODS) state.TIME_PERIODS = data.TIME_PERIODS;
      render();
    }

    function loadDoc() {
      makeRequest("GET", "http://54.183.93.210:3001/generate", null, function (res) {
        window.open(res.responseText, "_blank");
      });
    }

    function makeRequest(method, url, data, success, error) {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
         success(this);
       } else if (this.readyState === 4) {
         //alert("Error on " + url + ": " + this.statusText);
         error(this);
       }
      };
      xhttp.open(method, url, true);
      console.log(method, data);
      if (method === "GET") xhttp.send();
      else {
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.send(JSON.stringify(data));
      }
    }
  </script>

  <script type="text/javascript">
    function render() {
      let table = document.getElementById("content-table");
      while (table.firstChild) table.removeChild(table.firstChild);

      if (state.active === 'categories') table.appendChild(renderCategories(state.categories));
      else if (state.active === 'tasks') table.appendChild(renderTasks(state.tasks));
      else if (state.active === 'paperwork') table.appendChild(renderPaperwork(state.paperwork));

      $('select').selectpicker();
    }

    function renderCategories(categories) {
      return generateAccordion(categories, {
        heading: function (item) { return "Category " + item.number + " - " + item.title; },
        readonly: function (item) { return item.intro; },
        editlayout: function (item) { return [
            {type: "input", value: item.title, width: "33%", id: "input-1-"},
            {type: "div", width: "34%", display: "inline-block"},
            {type: "input", value: item.number, width: "33%", id: "input-2-"},
            {type: "textarea", value: item.intro, width: "100%", id: "textarea-"}
        ]; },
        save: function (item, i) {
          let title = document.getElementById("input-1-" + i).value;
          let number = parseInt(document.getElementById("input-2-" + i).value);
          let intro = document.getElementById("textarea-" + i).value;
          let data = {_id: item._id, title, number, intro};
          console.log(data);
          makeRequest("POST", "http://54.183.93.210:3001/data/category", data, saveResponse(categories, "categories"), function(err) {
            console.log(err);
          });
        },
        createText: "New Category",
        createSchema: {title: "New Category", number: 0, intro: ""}
      });
    }

    function renderTasks(tasks) {
      return generateAccordion(tasks, {
        heading: function (item) { console.log(item); return "Task - " + item.title + " - " + (item.category && item.category.title || "No Category"); },
        readonly: function (item) {
          let result = "Timeline: " + item.timeline + "<br/>Required: " + item.required;
          result += "<br/>Pre-Reqs: ";
          for(var k = 0; k < item.prereqs.length; k++) { result += item.prereqs[k].title + ", "; }
          result = result.substring(0, result.length - 1);
          result += "<br/>Paperwork: ";
          for(var k = 0; k < item.paperwork.length; k++) { result += item.paperwork[k].title + ", "; }
          result = result.substring(0, result.length - 1);
          result += "<br/>" + item.description;
          return result;
        },
        editlayout: function (item) { return [
            {type: "input", value: item.title, width: "30%", id: "input-1-"},
            {type: "div", width: "10%", display: "inline-block"},
            {type: "select", multiple: false, options: state.TIME_PERIODS.map(function(p) {return {_id: p, title: p};}), selected: item.timeline, width: "30%", id: "select-4-"},
            {type: "div", width: "10%", display: "inline-block"},
            {type: "checkbox", value: item.required, width: "20%", id: "input-3-"},
            {type: "select", multiple: true, options: state.tasks.map(function (p) {return {_id: p._id, title: p.title};}), selected: item.prereqs, width: "30%", id: "select-1-"},
            {type: "div", width: "5%", display: "inline-block"},
            {type: "select", multiple: true, options: state.paperwork.map(function (p) {return {_id: p._id, title: p.title};}), selected: item.paperwork, width: "30%", id: "select-2-"},
            {type: "div", width: "5%", display: "inline-block"},
            {type: "select", multiple: false, options: state.categories.map(function (c) {return {_id: c._id, title: c.title};}), selected: item.category && item.category._id, width: "30%", id: "select-3-"},
            {type: "textarea", value: item.description, width: "100%", id: "textarea-"}
        ]; },
        save: function (item, i) {
          let title = document.getElementById("input-1-" + i).value;
          let timeline = document.getElementById("select-4-" + i).value;
          let required = document.getElementById("input-3-" + i).checked;
          let prereqs = Array.from(document.getElementById('select-1-' + i).selectedOptions).map(function(s) {return s.value});
          let paperwork = Array.from(document.getElementById('select-2-' + i).selectedOptions).map(function(s) {return s.value});
          let category = document.getElementById('select-3-' + i).value;
          let description = document.getElementById('textarea-' + i).value;
          let data = {_id: item._id, title, timeline, required, prereqs, paperwork, category, description};
          console.log(data);
          makeRequest("POST", "http://54.183.93.210:3001/data/task", data, saveResponse(tasks, "tasks"), function(err) {
            console.log(err);
          });
        },
        createText: "New Task",
        createSchema: {title: "New Task", description: "", prereqs: [], paperwork: [], category: null, timeline: "", required: false}
      });
    }

    function renderPaperwork(paperwork) {
      return generateAccordion(paperwork, {
        heading: function (item) { console.log(item); return "Paperwork - " + item.title + " - " + (item.category && item.category.title || "No Category"); },
        readonly: function (item) { return item.description; },
        editlayout: function (item) { return [
            {type: "input", value: item.title, width: "30%", id: "input-1-"},
            {type: "div", width: "40%", display: "inline-block"},
            {type: "select", multiple: false, options: state.categories.map(function (c) {return {_id: c._id, title: c.title};}), selected: item.category && item.category._id, width: "30%", id: "select-1-"},
            {type: "textarea", value: item.description, width: "100%", id: "textarea-"}
        ]; },
        save: function (item, i) {
          let title = document.getElementById("input-1-" + i).value;
          let category = document.getElementById('select-1-' + i).value;
          let description = document.getElementById('textarea-' + i).value;
          let data = {_id: item._id, title, category, description};
          console.log(data);
          makeRequest("POST", "http://54.183.93.210:3001/data/paperwork", data, saveResponse(paperwork, "paperwork"), function(err) {
            console.log(err);
          });
        },
        createText: "New Paperwork",
        createSchema: {title: "New Paperwork", description: "", category: null}
      });
    }

    function saveResponse (data, key) {
      return function (res) {
        let dat = JSON.parse(res.responseText);
        if (data.slice(-1)[0].number === 0) {
          let updateData = {};
          updateData[key] = data.slice(0, -1).concat([dat]);
          updateState(updateData);
          document.getElementById("accordion-toggle-" + (data.length - 1)).click();
        } else {
          let newData = [];
          let index = 0;
          for(var j = 0; j < data.length; j++) {
            if (data[j].number === dat.number) {
              newData.push(dat);
              index = j;
            } else newData.push(data[j]);
          }
          let updateData = {};
          updateData[key] = newData;
          updateState(updateData);
          document.getElementById("accordion-toggle-" + index).click();
        }
      };
    }
  </script>

  <script type="text/javascript">
    function generateAccordion(data, options) {
      let accordion = document.createElement("div");
      accordion.setAttribute("id", "accordion");
      accordion.className = "mb-3";

      for (let i = 0; i < data.length; i++) {
        let card = document.createElement("div");
        card.className = "card";
        let cardHeader = document.createElement("div");
        cardHeader.className = "card-header bg-light";
        cardHeader.setAttribute("id", "heading" + i);
        let header = document.createElement("h5");
        header.className = "mb-0";
        let btn = document.createElement("button");
        btn.className = "btn collapsed";
        btn.setAttribute("id", "accordion-toggle-" + i);
        btn.setAttribute("data-toggle", "collapse");
        btn.setAttribute("data-target", "#collapse" + i);
        btn.setAttribute("aria-expanded", "false");
        btn.setAttribute("aria-controls", "collapse" + i);
        btn.innerHTML = options.heading(data[i]);

        header.appendChild(btn);
        cardHeader.appendChild(header);
        card.appendChild(cardHeader);

        let collapse = document.createElement("div");
        collapse.className = "collapse";
        collapse.setAttribute("id", "collapse" + i);
        collapse.setAttribute("aria-labelledby", "heading" + i);

        // Create view-only version of item
        let cardBody = document.createElement("div");
        cardBody.className = "card-body";
        cardBody.innerHTML = options.readonly(data[i]);
        cardBody.setAttribute("id", "collapse-body" + i);
        cardBody.appendChild(generateButtonGroup([
          {class: "btn-sm btn-outline-secondary", name: "Edit", onclick: function() {
            document.getElementById("collapse-body" + i).style.display = "none";
            document.getElementById("collapse-body-edit" + i).style.display = "block";
          }},
        ]));

        // Create editing version of item
        let editCardBody = document.createElement("div");
        editCardBody.className = "card-body";
        editCardBody.style.display = "none";
        editCardBody.setAttribute("id", "collapse-body-edit" + i);

        for(var k = 0; k < options.editlayout(data[i]).length; k++) {
          let opts = options.editlayout(data[i])[k];
          if (opts.type !== "checkbox" && opts.type !== "select") {
            let element = document.createElement(opts.type);
            if (opts.type) element.type = opts.type;
            if (opts.value) element.value = opts.value;
            if (opts.width) element.style.width = opts.width;
            if (opts.display) element.style.display = opts.display;
            if (opts.id) element.setAttribute("id", opts.id + i);
            if (opts.type === "textarea") element.rows = "10";
            editCardBody.appendChild(element);
          } else if (opts.type === "checkbox"){
            let element = document.createElement("div");
            element.className = "checkbox";
            element.style.display = "inline-block";
            if (opts.width) element.style.width = opts.width;

            let label = document.createElement("label");
            let input = document.createElement("input");
            input.type = "checkbox";
            if (opts.value) input.setAttribute("checked", opts.value);
            if (opts.id) input.setAttribute("id", opts.id + i);
            label.appendChild(document.createTextNode("Required:"));
            label.appendChild(input);
            element.appendChild(label);
            editCardBody.appendChild(element);
          } else {
            let element = document.createElement("select");
            if (opts.multiple) element.className = "selectpicker";
            if (opts.multiple) element.multiple = true;
            if (opts.multiple) element.setAttribute("data-live-search", "true");
            if (opts.width) element.style.width = opts.width;
            if (opts.id) element.setAttribute("id", opts.id + i);
            opts.options.forEach(function (choice) {
              let option = document.createElement("option");
              option.value = choice._id;
              option.innerHTML = choice.title;
              if (opts.selected && opts.multiple && opts.selected.indexOf(choice._id) >= 0) option.setAttribute("selected", "true");
              else if (opts.selected && opts.selected === choice._id) option.setAttribute("selected", "true");
              element.appendChild(option);
            })
            editCardBody.appendChild(element);
          }
        }

        editCardBody.appendChild(generateButtonGroup([
          {class: "btn-sm btn-outline-secondary", name: "Save", onclick: function() {
            options.save(data[i], i);
            document.getElementById("collapse-body" + i).style.display = "block";
            document.getElementById("collapse-body-edit" + i).style.display = "none";
          }},
          {class: "btn-sm btn-outline-secondary", name: "Cancel", onclick: function() {
            document.getElementById("collapse-body" + i).style.display = "block";
            document.getElementById("collapse-body-edit" + i).style.display = "none";
          }}
        ]));


        collapse.appendChild(cardBody);
        collapse.appendChild(editCardBody);
        card.appendChild(collapse);
        accordion.appendChild(card);
      }

      accordion.appendChild(generateButtonGroup([
        {class: "btn-sm btn-outline-secondary", name: options.createText, onclick: function() {
          let index = data.length;
          data.push(options.createSchema);
          render();

          document.getElementById("accordion-toggle-" + index).click();
          document.getElementById("collapse-body" + index).style.display = "none";
          document.getElementById("collapse-body-edit" + index).style.display = "block";
        }}
      ]));

      return accordion;
    }

    function generateButtonGroup(data) {
      let dFlex = document.createElement("div");
      dFlex.className = "d-flex justify-content-between align-items-center";
      let btnGroup = document.createElement("div");
      btnGroup.classList.add("btn-group");

      for(var i = 0; i < data.length; i++) {
        let btn = document.createElement("button");
        btn.setAttribute("type", "button");
        btn.className = "btn " + data[i].class;
        btn.innerHTML = data[i].name;
        btn.onclick = data[i].onclick;
        btnGroup.appendChild(btn);
      }
      dFlex.appendChild(btnGroup);
      return dFlex;
    }
  </script>
</body>
</html>
